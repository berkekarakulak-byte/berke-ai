<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Berke AI ‚Ä¢ Admin</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101826;
      --panel2:#0f1623;
      --text:#e8eefc;
      --muted:#a8b3cf;
      --line:rgba(255,255,255,.08);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --chip: rgba(255,255,255,.04);
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#f0f3ff;
      --text:#0a0d14;
      --muted:#475569;
      --line:rgba(2,6,23,.10);
      --shadow: 0 12px 40px rgba(2,6,23,.12);
      --chip: rgba(2,6,23,.04);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 10% 10%, rgba(110,231,255,.18), transparent 55%),
                  radial-gradient(1000px 650px at 90% 0%, rgba(167,139,250,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      min-height:100%;
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:min(1200px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%), var(--panel);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.35), transparent),
                  linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(110,231,255,.18);
    }
    .brand h1{
      font-size:15px; margin:0; letter-spacing:.4px;
      line-height:1.1;
    }
    .brand .sub{
      font-size:12px; color:var(--muted);
      margin-top:2px;
    }
    .actions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .chip{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: var(--chip);
      display:flex; align-items:center; gap:8px;
      color: var(--muted);
      user-select:none;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      transition: transform .05s ease, background .2s ease;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#0b0f17;
    }
    .btn.danger{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
    }
    .btn.icon{ width:44px; padding:10px 0; }

    .content{
      padding:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .card h2{
      margin:0 0 6px;
      font-size:14px;
      letter-spacing:.3px;
    }
    .muted{ color:var(--muted); font-size:12px; }

    .kpi{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:10px;
    }
    .kpi .num{
      font-size:28px;
      font-weight:900;
      letter-spacing:.5px;
    }
    .kpi .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .search{
      flex:1;
      min-width:220px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .search input{
      border:0; outline:none;
      background:transparent;
      color:var(--text);
      width:100%;
      font-size:13px;
    }
    .search input::placeholder{
      color: rgba(168,179,207,.75);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.02);
    }
    thead th{
      text-align:left;
      font-size:12px;
      padding:12px;
      color: var(--muted);
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:12px;
      font-size:13px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      word-break: break-word;
    }
    tbody tr:hover td{
      background: rgba(255,255,255,.03);
    }
    tbody tr:last-child td{
      border-bottom:0;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      user-select:none;
    }
    .pill.good{ border-color: rgba(34,197,94,.35); }
    .pill.warn{ border-color: rgba(245,158,11,.35); }
    .pill.bad{ border-color: rgba(239,68,68,.35); }

    .footnote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background: var(--panel2);
      border:1px solid var(--line);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      display:none;
      max-width: min(520px, 92vw);
      font-size:13px;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body data-theme="dark">
  <div class="wrap">
    <div class="app">
      <div class="topbar">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Berke AI ‚Ä¢ Admin Panel</h1>
            <div class="sub" id="subline">kullanƒ±cƒ± giri≈üleri ‚Ä¢ istatistik ‚Ä¢ g√ºvenli g√∂r√ºnt√ºleme</div>
          </div>
        </div>

        <div class="actions">
          <div class="chip" id="whoChip">Y√ºkleniyor‚Ä¶</div>
          <button class="btn icon" id="themeBtn" title="Tema">üåô</button>
          <button class="btn" id="refreshBtn">üîÑ Yenile</button>
          <button class="btn" id="exportBtn">‚¨áÔ∏è CSV</button>
          <button class="btn primary" id="goChatBtn">üí¨ Sohbet</button>
          <button class="btn danger" id="logoutBtn">√áƒ±kƒ±≈ü</button>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="card">
            <h2>Google kullanƒ±cƒ±</h2>
            <div class="kpi">
              <div>
                <div class="num" id="userCount">‚Äî</div>
                <div class="muted">Toplam kayƒ±tlƒ± kullanƒ±cƒ±</div>
              </div>
              <div class="tag">DB √ºzerinden</div>
            </div>
          </div>

          <div class="card">
            <h2>Misafir giri≈ü</h2>
            <div class="kpi">
              <div>
                <div class="num" id="guestCount">‚Äî</div>
                <div class="muted">Toplam misafir sayƒ±sƒ±</div>
              </div>
              <div class="tag">DB √ºzerinden</div>
            </div>
          </div>

          <div class="card">
            <h2>Durum</h2>
            <div class="kpi">
              <div>
                <div class="num" id="statusKpi">‚úÖ</div>
                <div class="muted" id="statusText">Her ≈üey yolunda</div>
              </div>
              <div class="tag" id="envTag">Render / Local</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="toolbar">
            <div class="search">
              üîé
              <input id="q" placeholder="Email / isim ara‚Ä¶ (√∂rn: gmail, berke)" />
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <span class="pill good" id="adminPill">üõ°Ô∏è Admin: ‚Äî</span>
              <span class="pill" id="updatedPill">‚è±Ô∏è G√ºncelleme: ‚Äî</span>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto; border-radius:16px;">
            <table>
              <thead>
                <tr>
                  <th style="width:34%">Email</th>
                  <th style="width:22%">ƒ∞sim</th>
                  <th style="width:12%">Giri≈ü sayƒ±sƒ±</th>
                  <th style="width:22%">Son giri≈ü</th>
                  <th style="width:10%">Rol</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="5" class="muted">Y√ºkleniyor‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <div class="footnote">
            ‚Ä¢ Bu tablo <b>/api/admin/stats</b> √ºzerinden geliyor. <br/>
            ‚Ä¢ Ki≈üilerin maili sadece admin tarafƒ±ndan g√∂r√ºn√ºr. <br/>
            ‚Ä¢ ƒ∞stersen bir sonraki adƒ±mda ‚Äúkullanƒ±cƒ± detay sayfasƒ±‚Äù + ‚Äúsohbet ge√ßmi≈üi listesi‚Äù de ekleriz.
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const whoChip = document.getElementById("whoChip");
  const themeBtn = document.getElementById("themeBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const exportBtn = document.getElementById("exportBtn");
  const goChatBtn = document.getElementById("goChatBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const userCount = document.getElementById("userCount");
  const guestCount = document.getElementById("guestCount");
  const statusKpi = document.getElementById("statusKpi");
  const statusText = document.getElementById("statusText");
  const envTag = document.getElementById("envTag");

  const adminPill = document.getElementById("adminPill");
  const updatedPill = document.getElementById("updatedPill");
  const tbody = document.getElementById("tbody");
  const q = document.getElementById("q");
  const toast = document.getElementById("toast");

  const THEME_KEY = "berke_ai_theme_v1";

  let rawUsers = [];

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 2200);
  }

  function loadTheme(){
    const t = localStorage.getItem(THEME_KEY);
    if(t) document.body.setAttribute("data-theme", t);
    themeBtn.textContent = document.body.getAttribute("data-theme")==="dark" ? "üåô" : "‚òÄÔ∏è";
  }

  themeBtn.onclick = ()=>{
    const cur = document.body.getAttribute("data-theme");
    const next = (cur==="dark") ? "light" : "dark";
    document.body.setAttribute("data-theme", next);
    localStorage.setItem(THEME_KEY, next);
    themeBtn.textContent = next==="dark" ? "üåô" : "‚òÄÔ∏è";
  };

  function fmtDate(iso){
    if(!iso) return "‚Äî";
    try{
      const d = new Date(iso);
      return d.toLocaleString([], {year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"});
    }catch{
      return iso;
    }
  }

  async function apiMe(){
    const r = await fetch("/api/me", {credentials:"include"});
    return await r.json();
  }

  async function apiStats(){
    const r = await fetch("/api/admin/stats", {credentials:"include"});
    const data = await r.json();
    if(!r.ok){
      throw new Error(data.detail || "Admin stats hata");
    }
    return data;
  }

  function renderTable(){
    const query = (q.value || "").trim().toLowerCase();
    const users = rawUsers.filter(u=>{
      if(!query) return true;
      return (u.email||"").toLowerCase().includes(query) || (u.name||"").toLowerCase().includes(query);
    });

    tbody.innerHTML = "";
    if(users.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">Sonu√ß yok.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for(const u of users){
      const tr = document.createElement("tr");
      const role = u.is_admin ? `<span class="pill good">Admin</span>` : `<span class="pill">User</span>`;
      tr.innerHTML = `
        <td>${escapeHtml(u.email || "")}</td>
        <td>${escapeHtml(u.name || "‚Äî")}</td>
        <td><b>${u.login_count ?? 0}</b></td>
        <td>${escapeHtml(fmtDate(u.last_login_at))}</td>
        <td>${role}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(str){
    return (str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function toCSV(users){
    const rows = [
      ["email","name","login_count","last_login_at","is_admin"]
    ];
    for(const u of users){
      rows.push([
        u.email || "",
        u.name || "",
        String(u.login_count ?? 0),
        u.last_login_at || "",
        String(!!u.is_admin),
      ]);
    }
    return rows.map(r => r.map(cell=>{
      const s = String(cell).replaceAll('"','""');
      return `"${s}"`;
    }).join(",")).join("\n");
  }

  function download(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function refresh(){
    try{
      statusKpi.textContent = "‚è≥";
      statusText.textContent = "Y√ºkleniyor‚Ä¶";

      const me = await apiMe();
      if(!me.logged_in){
        whoChip.textContent = "üîí Giri≈ü yok";
        adminPill.textContent = "üõ°Ô∏è Admin: hayƒ±r";
        statusKpi.textContent = "‚õî";
        statusText.textContent = "√ñnce Google ile giri≈ü yap";
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Giri≈ü yok.</td></tr>`;
        return;
      }

      whoChip.textContent = "‚úÖ " + (me.email || me.name || "Admin");
      adminPill.textContent = "üõ°Ô∏è Admin: " + (me.is_admin ? "evet" : "hayƒ±r");

      const data = await apiStats();

      rawUsers = data.users || [];
      userCount.textContent = String(rawUsers.length);
      guestCount.textContent = String(data.guest_count ?? 0);

      updatedPill.textContent = "‚è±Ô∏è G√ºncelleme: " + new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      renderTable();

      statusKpi.textContent = "‚úÖ";
      statusText.textContent = "Her ≈üey yolunda";

      envTag.textContent = location.hostname.includes("onrender.com") ? "Render" : "Local";
    } catch (e){
      statusKpi.textContent = "‚õî";
      statusText.textContent = "Hata";
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Hata: ${escapeHtml(e.message || String(e))}</td></tr>`;
      showToast("Admin stats alƒ±namadƒ±");
    }
  }

  refreshBtn.onclick = ()=>refresh();

  exportBtn.onclick = ()=>{
    const csv = toCSV(rawUsers);
    const name = "berke_ai_users_" + new Date().toISOString().slice(0,10) + ".csv";
    download(name, csv);
    showToast("CSV indirildi ‚úÖ");
  };

  goChatBtn.onclick = ()=>{ window.location.href = "/"; };

  logoutBtn.onclick = async ()=>{
    await fetch("/logout", {method:"POST", credentials:"include"});
    window.location.href = "/";
  };

  q.addEventListener("input", ()=>renderTable());

  loadTheme();
  refresh();
</script>
</body>
</html>
