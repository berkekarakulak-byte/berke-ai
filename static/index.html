<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Berke AI</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0b121a;
      --border:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.6);
      --accent:#3b82f6;
      --good:#22c55e;
      --warn:#f59e0b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:18px;
      --bubbleUser:#1f2a37;
      --bubbleAI:#0e1b2a;
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#f1f3f7;
      --border:rgba(0,0,0,.08);
      --text:rgba(0,0,0,.88);
      --muted:rgba(0,0,0,.55);
      --accent:#2563eb;
      --shadow: 0 20px 60px rgba(0,0,0,.12);
      --bubbleUser:#eef2ff;
      --bubbleAI:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(59,130,246,.18), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }

    /* Layout */
    .app{
      height:100%;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:18px;
      gap:16px;
    }
    .shell{
      width:min(1100px, 100%);
      height:100%;
      display:flex;
      flex-direction:column;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:0;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 25%, rgba(59,130,246,.95), rgba(59,130,246,.15) 55%),
                  radial-gradient(circle at 70% 75%, rgba(34,197,94,.75), rgba(34,197,94,.10) 60%),
                  rgba(255,255,255,.06);
      border:1px solid var(--border);
    }
    .brand h1{
      font-size:14px;margin:0;letter-spacing:.2px;font-weight:700;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand .sub{
      font-size:12px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .right{
      display:flex;align-items:center;gap:10px;
    }
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border:1px solid var(--border);border-radius:999px;
      background:rgba(255,255,255,.04);
      max-width:320px;
    }
    .avatar{
      width:26px;height:26px;border-radius:999px;background:rgba(255,255,255,.08);
      border:1px solid var(--border); overflow:hidden; flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .who{min-width:0}
    .who .name{font-size:12px;font-weight:650;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .who .mail{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    button{
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:650;
      cursor:pointer;
      transition:.15s ease;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
    button:active{transform:translateY(0px)}
    .btnAccent{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35)}
    .btnAccent:hover{background:rgba(59,130,246,.25)}
    .btnGhost{background:transparent}
    .btnSmall{padding:8px 10px;border-radius:10px;font-size:12px}
    .iconBtn{width:40px;height:40px;display:grid;place-items:center;padding:0;border-radius:12px}

    .content{
      display:flex;
      flex:1 1 auto;
      min-height:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.0), rgba(0,0,0,.05));
    }

    /* Chat */
    .chat{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .messages{
      flex:1 1 auto;
      overflow:auto;
      padding:18px 14px 10px 14px;
      scroll-behavior:smooth;
    }
    .row{
      display:flex;
      margin:10px 0;
      gap:10px;
      align-items:flex-end;
    }
    .row.user{justify-content:flex-end}
    .row.ai{justify-content:flex-start}

    .bubble{
      max-width:min(760px, 92%);
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
      position:relative;
    }
    .row.user .bubble{background:var(--bubbleUser)}
    .row.ai .bubble{background:var(--bubbleAI)}
    .meta{
      display:flex;gap:8px;align-items:center;
      margin-top:6px;
      font-size:11px;color:var(--muted);
      justify-content:space-between;
    }
    .actions{
      display:flex;gap:6px;align-items:center;
    }
    .chip{
      font-size:11px;
      padding:5px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background:rgba(255,255,255,.07)}
    .pinned{
      border-color:rgba(245,158,11,.45) !important;
      box-shadow:0 0 0 2px rgba(245,158,11,.12) inset;
    }

    .composer{
      padding:12px;
      border-top:1px solid var(--border);
      background: linear-gradient(to top, rgba(255,255,255,.05), rgba(255,255,255,.02));
      display:flex;gap:10px;align-items:flex-end;
    }
    textarea{
      flex:1 1 auto;
      min-height:46px;
      max-height:160px;
      resize:none;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-size:14px;
      line-height:1.35;
    }
    textarea:focus{border-color:rgba(59,130,246,.45);box-shadow:0 0 0 3px rgba(59,130,246,.12)}
    .sendBtn{height:46px;width:52px;border-radius:14px}
    .hint{font-size:11px;color:var(--muted);padding:0 14px 12px 14px}

    /* Drawer */
    .side{
      width:340px;
      border-left:1px solid var(--border);
      background:rgba(255,255,255,.02);
      display:flex;flex-direction:column;
    }
    .sideHead{
      padding:14px 14px 10px 14px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;
    }
    .sideHead .t{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:.2px}
    .panel{
      padding:12px 14px;
      overflow:auto;
    }
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.03);
      margin-bottom:12px;
    }
    .card h3{margin:0 0 8px 0;font-size:13px}
    .card p{margin:0;color:var(--muted);font-size:12px;line-height:1.4}
    .rowBtns{display:flex;gap:10px;margin-top:10px}
    .rowBtns button{flex:1}

    /* Login overlay */
    .overlay{
      position:fixed;inset:0;
      display:flex;align-items:center;justify-content:center;
      padding:18px;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:50;
    }
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--border);
      border-radius:22px;
      background:linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding:18px;
    }
    .modalTop{display:flex;align-items:center;gap:12px}
    .modalTop .logo{width:44px;height:44px;border-radius:14px}
    .modal h2{margin:0;font-size:16px}
    .modal .desc{margin:6px 0 0 0;color:var(--muted);font-size:12px;line-height:1.4}
    .stack{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .bigBtn{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      gap:10px;
      font-size:14px;
    }
    .googleIcon{
      width:18px;height:18px;border-radius:6px;
      background:conic-gradient(from 0deg, #ea4335, #fbbc05, #34a853, #4285f4, #ea4335);
      border:1px solid rgba(255,255,255,.25);
    }

    .toast{
      position:fixed;bottom:16px;left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.70);
      color:white;
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      padding:10px 12px;
      font-size:12px;
      display:none;
      z-index:60;
    }

    /* Mobile */
    @media (max-width: 980px){
      .side{display:none}
      .shell{border-radius:16px}
      .messages{padding:14px 10px 10px 10px}
      .composer{padding:10px}
    }
  </style>
</head>
<body>
<div class="app">
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <h1 id="brandTitle">Berke AI</h1>
          <div class="sub" id="brandSub">Ultra premium ‚Ä¢ Dark edition</div>
        </div>
      </div>

      <div class="right">
        <button class="iconBtn" id="themeBtn" title="Tema">
          üåô
        </button>

        <div class="pill" id="whoPill" style="display:none;">
          <div class="avatar" id="avatarBox"></div>
          <div class="who">
            <div class="name" id="whoName">Kullanƒ±cƒ±</div>
            <div class="mail" id="whoMail">‚Äî</div>
          </div>
        </div>

        <button class="btnSmall btnGhost" id="adminBtn" style="display:none;">Admin</button>
        <button class="btnSmall" id="logoutBtn" style="display:none;">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="content">
      <div class="chat">
        <div class="messages" id="messages"></div>

        <div class="hint" id="typingHint" style="display:none;">AI yazƒ±yor‚Ä¶</div>

        <div class="composer">
          <textarea id="input" placeholder="Mesaj yaz‚Ä¶ (Enter: g√∂nder ‚Ä¢ Shift+Enter: yeni satƒ±r)"></textarea>
          <button class="sendBtn btnAccent" id="sendBtn" title="G√∂nder">‚û§</button>
        </div>
      </div>

      <div class="side">
        <div class="sideHead">
          <div class="t">Ara√ßlar</div>
          <div style="display:flex;gap:8px">
            <button class="btnSmall" id="soundBtn" title="Ses">üîä</button>
            <button class="btnSmall" id="imgBtn" title="G√∂rsel">üñºÔ∏è</button>
          </div>
        </div>
        <div class="panel">
          <div class="card">
            <h3>üß† Pin + Kopyala</h3>
            <p>Mesajlarƒ±n saƒüƒ±ndaki ‚ÄúPin‚Äù ile sabitleyebilir, ‚ÄúKopyala‚Äù ile tek tƒ±k kopyalayabilirsin.</p>
          </div>
          <div class="card">
            <h3>üñºÔ∏è G√∂rsel √ºretim</h3>
            <p>Saƒü √ºstteki ‚ÄúG√∂rsel‚Äù butonuna basƒ±nca prompt sorar. (B√ºt√ße limiti varsa hata g√∂sterebilir.)</p>
          </div>
          <div class="card">
            <h3>üëÄ Okundu / Yazƒ±yor</h3>
            <p>AI cevap √ºretirken ‚ÄúAI yazƒ±yor‚Ä¶‚Äù g√∂r√ºn√ºr.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Login Overlay -->
<div class="overlay" id="overlay" style="display:none;">
  <div class="modal">
    <div class="modalTop">
      <div class="logo"></div>
      <div>
        <h2>Giri≈ü yap</h2>
        <p class="desc">Google ile giri≈ü yap veya misafir olarak devam et. (Admin paneli sadece yetkili mailde g√∂r√ºn√ºr.)</p>
      </div>
    </div>

    <div class="stack">
      <button class="bigBtn btnAccent" id="googleBtn">
        <span class="googleIcon"></span>
        Google ile giri≈ü yap
      </button>
      <button class="bigBtn" id="guestBtn">
        Misafir olarak devam et
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // -----------------------------
  // helpers
  // -----------------------------
  const $ = (id)=>document.getElementById(id);
  const messagesEl = $("messages");
  const inputEl = $("input");
  const typingHint = $("typingHint");
  const toastEl = $("toast");
  const overlayEl = $("overlay");

  const state = {
    history: [],
    sound: JSON.parse(localStorage.getItem("soundOn") || "true"),
    theme: localStorage.getItem("theme") || "dark",
    pinned: JSON.parse(localStorage.getItem("pinned") || "[]"), // array of message ids
  };

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    setTimeout(()=>toastEl.style.display="none", 2200);
  }

  function setTheme(theme){
    state.theme = theme;
    localStorage.setItem("theme", theme);
    document.documentElement.setAttribute("data-theme", theme === "light" ? "light" : "dark");
    $("themeBtn").textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
  }

  function playSend(){
    if(!state.sound) return;
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 720;
      g.gain.value = 0.04;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{o.stop(); ctx.close()}, 90);
    }catch(e){}
  }

  function formatTime(ts){
    const d = new Date(ts);
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  function renderMessage(msg){
    const row = document.createElement("div");
    row.className = "row " + (msg.role === "user" ? "user" : "ai");

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = msg.content;

    // pinned state
    if(state.pinned.includes(msg.id)){
      bubble.classList.add("pinned");
    }

    const meta = document.createElement("div");
    meta.className = "meta";

    const left = document.createElement("div");
    left.textContent = formatTime(msg.ts);

    const actions = document.createElement("div");
    actions.className = "actions";

    const copy = document.createElement("span");
    copy.className = "chip";
    copy.textContent = "Kopyala";
    copy.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(msg.content);
        toast("Kopyalandƒ± ‚úÖ");
      }catch(e){
        toast("Kopyalanamadƒ±");
      }
    };

    const pin = document.createElement("span");
    pin.className = "chip";
    pin.textContent = state.pinned.includes(msg.id) ? "Unpin" : "Pin";
    pin.onclick = ()=>{
      const idx = state.pinned.indexOf(msg.id);
      if(idx >= 0){
        state.pinned.splice(idx,1);
        bubble.classList.remove("pinned");
        pin.textContent = "Pin";
      }else{
        state.pinned.push(msg.id);
        bubble.classList.add("pinned");
        pin.textContent = "Unpin";
      }
      localStorage.setItem("pinned", JSON.stringify(state.pinned));
    };

    actions.appendChild(copy);
    actions.appendChild(pin);

    meta.appendChild(left);
    meta.appendChild(actions);

    bubble.appendChild(meta);
    row.appendChild(bubble);
    messagesEl.appendChild(row);
  }

  function pushMessage(role, content){
    const msg = { id: crypto.randomUUID(), role, content, ts: Date.now() };
    state.history.push({ role, content }); // server'a giden history sade
    renderMessage(msg);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function apiMe(){
    const r = await fetch("/api/me");
    return await r.json();
  }

  function showUser(me){
    $("whoPill").style.display = "flex";
    $("logoutBtn").style.display = "inline-flex";
    $("whoName").textContent = me.name || (me.kind === "guest" ? "Misafir" : "Kullanƒ±cƒ±");
    $("whoMail").textContent = me.email ? me.email : (me.kind === "guest" ? "guest" : "‚Äî");

    $("avatarBox").innerHTML = "";
    if(me.picture){
      const img = document.createElement("img");
      img.src = me.picture;
      $("avatarBox").appendChild(img);
    }else{
      $("avatarBox").textContent = me.kind === "guest" ? "G" : "üôÇ";
      $("avatarBox").style.display = "grid";
      $("avatarBox").style.placeItems = "center";
      $("avatarBox").style.fontSize = "12px";
    }

    if(me.is_admin){
      $("adminBtn").style.display = "inline-flex";
    }else{
      $("adminBtn").style.display = "none";
    }
  }

  async function ensureLogin(){
    const me = await apiMe();
    if(!me.logged_in){
      overlayEl.style.display = "flex";
      $("whoPill").style.display = "none";
      $("logoutBtn").style.display = "none";
      $("adminBtn").style.display = "none";
      return null;
    }
    overlayEl.style.display = "none";
    showUser(me);
    return me;
  }

  // -----------------------------
  // send logic (ENTER FIX)
  // -----------------------------
  async function send(){
    const text = inputEl.value.trim();
    if(!text) return;
    inputEl.value = "";
    playSend();
    pushMessage("user", text);

    typingHint.style.display = "block";

    try{
      const r = await fetch("/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: text, history: state.history })
      });
      const data = await r.json();
      typingHint.style.display = "none";

      if(!r.ok){
        pushMessage("assistant", (data.detail || "Hata olu≈ütu."));
        return;
      }

      pushMessage("assistant", data.reply || "");
    }catch(e){
      typingHint.style.display = "none";
      pushMessage("assistant", "Baƒülantƒ± hatasƒ± oldu. Tekrar dener misin?");
    }
  }

  inputEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });
  $("sendBtn").onclick = send;

  // -----------------------------
  // buttons
  // -----------------------------
  $("themeBtn").onclick = ()=>{
    setTheme(state.theme === "light" ? "dark" : "light");
  };

  $("soundBtn").onclick = ()=>{
    state.sound = !state.sound;
    localStorage.setItem("soundOn", JSON.stringify(state.sound));
    toast(state.sound ? "Ses a√ßƒ±k üîä" : "Ses kapalƒ± üîá");
    $("soundBtn").textContent = state.sound ? "üîä" : "üîá";
  };

  $("imgBtn").onclick = async ()=>{
    const prompt = window.prompt("G√∂rsel i√ßin kƒ±sa bir prompt yaz:");
    if(!prompt) return;

    typingHint.style.display = "block";
    try{
      const r = await fetch("/api/image", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await r.json();
      typingHint.style.display = "none";

      if(!r.ok){
        toast(data.detail || "G√∂rsel hatasƒ±");
        return;
      }

      // b64 -> g√∂ster
      const url = "data:image/png;base64," + data.b64;
      const w = window.open();
      w.document.write(`<img src="${url}" style="max-width:100%;height:auto;display:block;margin:0 auto;background:#111"/>`);
      toast("G√∂rsel hazƒ±r ‚úÖ");
    }catch(e){
      typingHint.style.display = "none";
      toast("G√∂rsel √ºretim baƒülantƒ± hatasƒ±");
    }
  };

  $("logoutBtn").onclick = async ()=>{
    await fetch("/logout", {method:"POST"});
    toast("√áƒ±kƒ±≈ü yapƒ±ldƒ±");
    location.href = "/";
  };

  $("adminBtn").onclick = ()=> location.href = "/admin-ui";

  $("googleBtn").onclick = ()=> location.href = "/auth/google";
  $("guestBtn").onclick = async ()=>{
    const r = await fetch("/auth/guest", {method:"POST"});
    if(r.ok){
      location.href = "/#chat";
    }else{
      toast("Misafir giri≈üi hata");
    }
  };

  // -----------------------------
  // init
  // -----------------------------
  (async function init(){
    setTheme(state.theme);
    $("soundBtn").textContent = state.sound ? "üîä" : "üîá";

    const me = await ensureLogin();
    if(me){
      // ho≈ügeldin
      pushMessage("assistant", "Selam! Hazƒ±rƒ±m üòÑ");
    }
  })();
</script>
</body>
</html>
