<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Berke AI</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#0f1629;
      --card:#121b33;
      --text:#e8eefc;
      --muted:#a7b4d1;
      --line:rgba(255,255,255,.08);
      --accent:#6ea8ff;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(110,168,255,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(51,209,122,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .app{height:100dvh;display:flex;justify-content:center;align-items:center;padding:14px}
    .shell{
      width:min(980px, 100%);
      height:min(860px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;background: rgba(15,22,41,.75);
      border-bottom:1px solid var(--line);backdrop-filter: blur(10px);
      gap:10px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px}
    .logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg, rgba(110,168,255,.95), rgba(51,209,122,.7));box-shadow:0 8px 20px rgba(110,168,255,.25)}
    .who{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:55%}
    .pill{border:1px solid var(--line);background: rgba(255,255,255,.03);padding:6px 10px;border-radius:999px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .btn:hover{border-color:rgba(110,168,255,.35)}
    .btn.danger{border-color:rgba(255,92,92,.35);background:rgba(255,92,92,.10)}

    .chat{flex:1;display:flex;flex-direction:column;background: rgba(11,15,25,.65)}
    .messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
    .bubbleWrap{display:flex;flex-direction:column;gap:6px}
    .bubble{
      max-width:min(78%, 680px);
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
      word-wrap:break-word;
      position:relative;
    }
    .bubble.me{align-self:flex-end;background:rgba(110,168,255,.12);border-color:rgba(110,168,255,.22)}
    .bubble.ai{align-self:flex-start;background:rgba(255,255,255,.035)}
    .meta{font-size:11px;color: rgba(231,238,252,.55);display:flex;justify-content:flex-end;gap:8px}
    .tools{
      position:absolute; top:8px; right:8px;
      display:none; gap:6px;
    }
    .bubble:hover .tools{display:flex}
    .toolBtn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size:11px;
      padding:4px 6px;
      border-radius:10px;
      cursor:pointer;
    }
    .toolBtn.pinOn{border-color:rgba(51,209,122,.5);background:rgba(51,209,122,.12)}

    .composer{
      border-top:1px solid var(--line);
      padding:12px;
      background: rgba(15,22,41,.65);
      display:flex;gap:10px;align-items:flex-end;
    }
    textarea{
      flex:1;resize:none;min-height:44px;max-height:140px;
      border-radius:14px;border:1px solid var(--line);
      background: rgba(255,255,255,.03);color:var(--text);
      padding:10px 12px;font-size:14px;outline:none;
    }
    textarea:focus{border-color:rgba(110,168,255,.45)}
    .send{
      width:52px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid rgba(110,168,255,.45);
      background: rgba(110,168,255,.16);
      cursor:pointer;font-weight:900;
    }

    .overlay{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center; padding:16px;
      background: rgba(0,0,0,.55); backdrop-filter: blur(10px);
    }
    .overlay.show{display:flex}
    .cardBox{
      width:min(520px, 100%);
      background: rgba(15,22,41,.85);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .cardBox h2{margin:0 0 8px;font-size:18px}
    .cardBox p{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35}
    .stack{display:flex;flex-direction:column;gap:10px}
    .bigbtn{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .bigbtn.primary{border-color:rgba(110,168,255,.45);background: rgba(110,168,255,.14)}
    .gicon{width:18px;height:18px;border-radius:4px;background:#fff;display:grid;place-items:center;color:#111;font-weight:900;font-family:Arial}
    .hint{margin-top:10px;font-size:12px;color:rgba(231,238,252,.55)}
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">
      <div class="topbar">
        <div class="brand"><div class="logo"></div><span>Berke AI</span></div>
        <div class="who">
          <span class="pill" id="whoPill">Misafir</span>
          <span id="emailText" style="overflow:hidden;text-overflow:ellipsis;"></span>
        </div>
        <div class="actions">
          <button class="btn" id="adminBtn" style="display:none;">Admin</button>
          <button class="btn danger" id="logoutBtn" style="display:none;">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
      </div>

      <div class="chat">
        <div class="messages" id="messages"></div>
        <div class="composer">
          <textarea id="input" placeholder="Mesaj yaz..." rows="1"></textarea>
          <div class="send" id="sendBtn">âž¤</div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="cardBox">
      <h2>Devam etmek iÃ§in</h2>
      <p>Google ile giriÅŸ yaparsan seni tanÄ±r ve tekrar uÄŸraÅŸtÄ±rmaz. Ä°stersen misafir de devam edebilirsin.</p>
      <div class="stack">
        <button class="bigbtn primary" id="googleBtn"><span class="gicon">G</span> Google ile giriÅŸ yap</button>
        <button class="bigbtn" id="guestBtn">Misafir olarak devam et</button>
      </div>
      <div class="hint">Ã‡Ä±kÄ±ÅŸ yaparsan tekrar giriÅŸ sorar.</div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const messagesEl = $("messages");
  const overlayEl = $("overlay");
  const whoPill = $("whoPill");
  const emailText = $("emailText");
  const logoutBtn = $("logoutBtn");
  const adminBtn = $("adminBtn");

  // Basit click sesi
  const clickSound = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=");
  function playClick(){ try{ clickSound.currentTime=0; clickSound.play(); }catch(e){} }

  function timeHHMM(d=new Date()){
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  async function api(path, opts={}){
    const res = await fetch(path, {
      credentials: "include",
      headers: {"Content-Type":"application/json"},
      ...opts
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.detail || "API error");
    return data;
  }

  function addBubble({id=null, text, who, pinned=false, created_at=null}){
    const wrap = document.createElement("div");
    wrap.className = "bubbleWrap";

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (who==="me" ? "me":"ai");
    bubble.textContent = text;
    bubble.dataset.mid = id || "";

    const tools = document.createElement("div");
    tools.className = "tools";

    // Copy
    const copyBtn = document.createElement("button");
    copyBtn.className = "toolBtn";
    copyBtn.textContent = "Kopyala";
    copyBtn.onclick = async (e)=>{
      e.stopPropagation();
      playClick();
      await navigator.clipboard.writeText(text);
      copyBtn.textContent = "KopyalandÄ±";
      setTimeout(()=>copyBtn.textContent="Kopyala", 900);
    };

    // Pin
    const pinBtn = document.createElement("button");
    pinBtn.className = "toolBtn" + (pinned ? " pinOn":"");
    pinBtn.textContent = pinned ? "Pinned":"Pin";
    pinBtn.onclick = async (e)=>{
      e.stopPropagation();
      playClick();
      if(!id) return; // eski mesaj id yoksa pinleme yok
      const next = !(pinBtn.classList.contains("pinOn"));
      await api("/pin", {method:"POST", body: JSON.stringify({message_id:id, pinned: next})});
      pinBtn.classList.toggle("pinOn", next);
      pinBtn.textContent = next ? "Pinned":"Pin";
    };

    tools.appendChild(copyBtn);
    tools.appendChild(pinBtn);
    bubble.appendChild(tools);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = created_at ? created_at.replace("T"," ").slice(11,16) : timeHHMM();

    wrap.appendChild(bubble);
    wrap.appendChild(meta);

    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function refreshMe(){
    const me = await api("/me");
    if(!me.logged_in){
      overlayEl.classList.add("show");
      whoPill.textContent = "Misafir";
      emailText.textContent = "";
      logoutBtn.style.display = "none";
      adminBtn.style.display = "none";
      return;
    }
    overlayEl.classList.remove("show");
    logoutBtn.style.display = "inline-flex";

    if(me.guest){
      whoPill.textContent = "Misafir";
      emailText.textContent = "";
    }else{
      whoPill.textContent = "GiriÅŸ yapÄ±ldÄ±";
      emailText.textContent = me.email ? ("â€¢ " + me.email) : "";
    }

    adminBtn.style.display = me.is_admin ? "inline-flex" : "none";
  }

  async function loadHistory(){
    const h = await api("/history");
    messagesEl.innerHTML = "";
    for(const m of h.messages){
      addBubble({
        id: m.id,
        text: m.content,
        who: (m.role === "ai" ? "ai" : "me"),
        pinned: !!m.is_pinned,
        created_at: m.created_at
      });
    }
    if(h.messages.length === 0){
      addBubble({text:"Selam kanka ðŸ˜„ HazÄ±rÄ±m. Ne yapÄ±yoruz?", who:"ai"});
    }
  }

  // Buttons
  $("googleBtn").onclick = ()=> { playClick(); window.location.href = "/auth/google"; };
  $("guestBtn").onclick = async ()=> {
    playClick();
    await api("/guest", {method:"POST", body: JSON.stringify({})});
    await refreshMe();
    await loadHistory();
  };

  logoutBtn.onclick = async ()=>{
    playClick();
    await api("/logout", {method:"POST", body: JSON.stringify({})});
    await refreshMe();
  };

  adminBtn.onclick = ()=> { playClick(); window.location.href = "/admin-ui"; };

  // Chat send
  async function send(){
    const input = $("input");
    const text = input.value.trim();
    if(!text) return;

    playClick();
    input.value = "";
    addBubble({text, who:"me"});

    try{
      const out = await api("/chat", {method:"POST", body: JSON.stringify({message:text})});
      addBubble({text: out.reply || "â€¦", who:"ai"});
    }catch(e){
      addBubble({text:"Åžu an teknik bir sorun var ama buradayÄ±m.", who:"ai"});
    }
  }

  // ENTER gÃ¶nder, SHIFT+ENTER alt satÄ±r
  $("input").addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });
  $("sendBtn").onclick = send;

  (async ()=>{
    await refreshMe();
    await loadHistory();
  })();
</script>
</body>
</html>
