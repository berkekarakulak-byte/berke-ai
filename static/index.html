<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Berke AI</title>

  <style>
    :root{
      --bg0:#050a14; --bg1:#0b1220;
      --txt:#e5e7eb; --mut:#94a3b8;
      --stroke: rgba(148,163,184,.18);
      --card: rgba(12,18,32,.65);
      --card2: rgba(12,18,32,.45);
      --shadow: 0 24px 80px rgba(0,0,0,.55);

      --aiBg: rgba(5,10,20,.30);
      --aiBorder: rgba(148,163,184,.14);

      --me1:#60a5fa;
      --me2:#a78bfa;

      --focus: rgba(96,165,250,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Arial;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(29,78,216,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(168,85,247,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* optional background image */
    body.has-bg{
      background: url("/static/bg.jpg") center/cover no-repeat fixed;
    }
    body.has-bg::before{
      content:"";
      position:fixed; inset:0;
      background: rgba(5,10,20,.70);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      z-index:-1;
    }

    .wrap{
      height:100dvh;
      display:flex;
      justify-content:center;
      padding:16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }
    .app{
      width:min(1000px, 100%);
      height:100%;
      border-radius:20px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    @media (max-width: 640px){
      .wrap{padding:0}
      .app{border-radius:0;border:none;box-shadow:none}
    }

    /* TOPBAR (admin panel vibe) */
    .top{
      flex:0 0 auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid rgba(148,163,184,.16);
      background: rgba(5,10,20,.25);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:.3px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg,#60a5fa,#a78bfa);
      box-shadow: 0 0 24px rgba(96,165,250,.35);
    }
    .sub{
      margin-top:2px;
      font-size:12px;
      color:var(--mut);
      font-weight:700;
    }
    .right{
      display:flex; gap:10px; align-items:center;
    }
    .pill{
      border:1px solid var(--stroke);
      background: rgba(5,10,20,.20);
      color:var(--txt);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .pill:hover{ background: rgba(5,10,20,.32); }

    /* LOGIN CARD */
    .login{
      flex:1 1 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .card{
      width:min(560px, 92vw);
      border:1px solid var(--stroke);
      background: rgba(5,10,20,.25);
      border-radius:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding:18px;
    }
    .h1{ font-size:18px; font-weight:900; margin:6px 0 10px; }
    .p{ font-size:13px; color:var(--mut); line-height:1.55; margin:0 0 14px; }

    .btn{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(5,10,20,.20);
      color:var(--txt);
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:hover{ background: rgba(5,10,20,.32); }

    .btn.google{
      background: rgba(255,255,255,.95);
      color:#0b1220;
      border:none;
    }
    .btn.google:hover{ background:#fff; }
    .small{ margin-top:12px; text-align:center; font-size:12px; color:var(--mut); }

    /* CHAT */
    .chat{
      flex:1 1 auto;
      min-height:0;
      display:none;
      flex-direction:column;
    }
    .msgs{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      padding:18px 14px 160px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .row{ display:flex; width:100%; }
    .row.ai{ justify-content:flex-start; }
    .row.me{ justify-content:flex-end; }

    .bubbleWrap{
      max-width:82%;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    @media (min-width: 860px){
      .bubbleWrap{ max-width: 64%; }
    }

    .bubble{
      border-radius:18px;
      padding:12px 14px;
      line-height:1.6;
      white-space:pre-wrap;
      word-wrap:break-word;
      font-size:15px;
      box-shadow: 0 10px 30px rgba(0,0,0,.30);
      border:1px solid var(--aiBorder);
      background: rgba(5,10,20,.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .row.ai .bubble{
      background: rgba(5,10,20,.22);
      border-bottom-left-radius:8px;
    }
    .row.me .bubble{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.95));
      border:1px solid rgba(96,165,250,.30);
      color:#081021;
      border-bottom-right-radius:8px;
    }

    .meta{
      font-size:11px;
      color: rgba(229,231,235,.68);
    }
    .row.me .meta{ text-align:right; }

    /* COMPOSER */
    .composer{
      position: sticky;
      bottom:0;
      padding:12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid rgba(148,163,184,.16);
      background: rgba(5,10,20,.40);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .inputWrap{
      display:flex;
      gap:10px;
      align-items:flex-end;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(5,10,20,.22);
      border-radius:16px;
      padding:10px;
      box-shadow: 0 16px 45px rgba(0,0,0,.35);
    }
    .inputWrap:focus-within{
      border-color: rgba(96,165,250,.35);
      box-shadow: 0 0 0 6px rgba(96,165,250,.10), 0 16px 45px rgba(0,0,0,.35);
    }
    textarea{
      flex:1 1 auto;
      border:none;
      outline:none;
      background: transparent;
      color:var(--txt);
      font-size:16px;
      line-height:1.5;
      min-height:26px;
      max-height:180px;
      resize:none;
    }
    textarea::placeholder{ color: rgba(148,163,184,.85); }
    .send{
      width:42px;
      height:42px;
      border:none;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      color:#081021;
      background: linear-gradient(135deg, var(--me1), var(--me2));
      box-shadow: 0 18px 50px rgba(96,165,250,.20);
    }
    .send:hover{ filter: brightness(1.05); }
    .typing{
      margin-top:10px;
      font-size:12px;
      color:var(--mut);
      display:none;
      text-align:center;
    }
    .hint{
      margin-top:8px;
      color:var(--mut);
      font-size:12px;
      text-align:center;
    }
    .hint code{
      padding:2px 6px;
      border-radius:8px;
      background: rgba(148,163,184,.10);
      border:1px solid rgba(148,163,184,.14);
      color: rgba(229,231,235,.85);
    }
  </style>
</head>

<body class="has-bg">
  <div class="wrap">
    <div class="app">
      <div class="top">
        <div>
          <div class="brand"><span class="dot"></span> Berke AI</div>
          <div class="sub" id="subtitle">Premium Dark â€¢ Glass UI</div>
        </div>
        <div class="right">
          <div class="pill" id="adminBtn" style="display:none;">Admin</div>
          <div class="pill" onclick="hardRefresh()">Hard Refresh</div>
        </div>
      </div>

      <!-- LOGIN -->
      <div class="login" id="login">
        <div class="card">
          <div class="h1">Devam etmek iÃ§in giriÅŸ yap</div>
          <p class="p">Google ile giriÅŸ yaparsan hafÄ±zan sana Ã¶zel tutulur. Misafir modunda sohbet Ã§alÄ±ÅŸÄ±r (hafÄ±za yok).</p>

          <button class="btn google" onclick="location.href='/auth/google'">
            <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true">
              <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.7 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.2 6.1 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.2-.1-2.3-.4-3.5z"/>
              <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 16 19 12 24 12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.2 6.1 29.3 4 24 4 16.3 4 9.6 8.4 6.3 14.7z"/>
              <path fill="#4CAF50" d="M24 44c5.1 0 9.8-2 13.3-5.2l-6.1-5.2C29.1 35.4 26.7 36 24 36c-5.2 0-9.6-3.3-11.3-8l-6.6 5.1C9.4 39.6 16.3 44 24 44z"/>
              <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.1 3-3.4 5.3-6.3 6.6l6.1 5.2C38.7 36.5 44 31.1 44 24c0-1.2-.1-2.3-.4-3.5z"/>
            </svg>
            Google ile devam et
          </button>

          <div style="height:10px"></div>

          <button class="btn" onclick="guest()">Misafir olarak devam et</button>

          <div class="small">Not: Edge cache bazen sapÄ±tÄ±yor. Ã‡alÄ±ÅŸmazsa Ctrl+F5 ya da gizli sekme.</div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="chat" id="chat">
        <div class="msgs" id="msgs"></div>

        <div class="composer">
          <form class="inputWrap" onsubmit="send(event)">
            <textarea id="m" rows="1" placeholder="Mesaj yazâ€¦ (Enter gÃ¶nder, Shift+Enter satÄ±r)"></textarea>
            <button class="send" type="submit" title="GÃ¶nder">âž¤</button>
          </form>
          <div class="typing" id="typing">Berke AI yazÄ±yorâ€¦</div>
          <div class="hint"><code>Enter</code> gÃ¶nderir â€¢ <code>Shift+Enter</code> satÄ±r</div>
        </div>
      </div>

    </div>
  </div>

<script>
  const msgs = document.getElementById("msgs");
  const typing = document.getElementById("typing");
  const ta = document.getElementById("m");
  const subtitle = document.getElementById("subtitle");

  const params = new URLSearchParams(location.search);
  const email = params.get("email") || "";
  const loginType = params.get("login") || "";

  function hardRefresh(){
    const u = new URL(location.href);
    u.searchParams.set("v", String(Date.now()));
    location.href = u.toString();
  }

  function showChat(){
    document.getElementById("login").style.display="none";
    document.getElementById("chat").style.display="flex";

    subtitle.textContent = email ? ("GiriÅŸ: " + email) : "Misafir Modu";

    // Admin butonu sadece sana
    if(email && email.toLowerCase() === "berkekarakulak@gmail.com"){
      const a = document.getElementById("adminBtn");
      a.style.display="inline-block";
      a.onclick = () => {
        const key = prompt("Admin key (Render ENV: ADMIN_PANEL_KEY)","");
        const url = key
          ? `/admin-ui?email=${encodeURIComponent(email)}&key=${encodeURIComponent(key)}`
          : `/admin-ui?email=${encodeURIComponent(email)}`;
        location.href = url;
      };
    }
    scrollBottom(true);
  }

  if(loginType === "google" && email){
    showChat();
  }

  async function guest(){
    fetch("/guest", {method:"POST"}).catch(()=>{});
    history.replaceState(null,"", "/");
    showChat();
  }

  // Enter gÃ¶nder / Shift+Enter satÄ±r
  ta.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      ta.form.requestSubmit();
    }
  });

  // Auto-grow textarea
  ta.addEventListener("input", ()=>{
    ta.style.height = "auto";
    ta.style.height = Math.min(180, ta.scrollHeight) + "px";
  });

  // iOS/Android keyboard scroll fix
  ta.addEventListener("focus", ()=> setTimeout(()=>scrollBottom(true), 200));

  function timeNow(){
    return new Date().toLocaleTimeString("tr-TR", {hour:"2-digit", minute:"2-digit"});
  }

  function addMsg(role, text){
    const row = document.createElement("div");
    row.className = "row " + role;

    const wrap = document.createElement("div");
    wrap.className = "bubbleWrap";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = timeNow();

    wrap.appendChild(bubble);
    wrap.appendChild(meta);
    row.appendChild(wrap);
    msgs.appendChild(row);

    scrollBottom(false);
  }

  function scrollBottom(force){
    if(force){
      msgs.scrollTop = msgs.scrollHeight;
      return;
    }
    // kullanÄ±cÄ± yukarÄ± scroll ediyorsa zorlamayalÄ±m
    const nearBottom = (msgs.scrollHeight - msgs.scrollTop - msgs.clientHeight) < 220;
    if(nearBottom) msgs.scrollTop = msgs.scrollHeight;
  }

  function typingOn(){ typing.style.display="block"; scrollBottom(true); }
  function typingOff(){ typing.style.display="none"; }

  async function send(e){
    if(e) e.preventDefault();

    const text = (ta.value || "").trim();
    if(!text) return;

    ta.value = "";
    ta.style.height = "auto";

    addMsg("me", text);
    typingOn();

    try{
      const r = await fetch("/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({message:text, email: email})
      });
      const j = await r.json();
      typingOff();
      addMsg("ai", j.reply || "BoÅŸ cevap geldi ðŸ˜…");
    }catch(err){
      typingOff();
      addMsg("ai", "BaÄŸlantÄ± hatasÄ± oldu. Tekrar dener misin?");
    }
  }
</script>
</body>
</html>
