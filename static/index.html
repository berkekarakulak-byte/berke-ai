<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berke AI</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --border:#243042;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(34,197,94,.12), transparent 60%),
                  radial-gradient(900px 600px at 80% 0%, rgba(59,130,246,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width: 1100px;
      margin: 28px auto;
      padding: 0 16px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.9), rgba(59,130,246,.9));
      box-shadow: var(--shadow);
    }
    .title{
      line-height:1.1;
    }
    .title b{display:block;font-size:16px}
    .title span{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(17,24,39,.7);
      backdrop-filter: blur(6px);
      max-width: 520px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pill small{color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: rgba(17,24,39,.75);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .cardHeader .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }
    .cardBody{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(15,23,42,.7);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color:#334155}
    .btn.primary{background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.35)}
    .btn.danger{background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.3)}
    .btn.warn{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35)}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}
    .input{
      width:100%;
      border:1px solid var(--border);
      background: rgba(15,23,42,.7);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      font-size: 14px;
    }
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border); margin:12px 0}
    .chat{
      height: 540px;
      display:flex;
      flex-direction:column;
    }
    .chatList{
      flex:1;
      overflow:auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      border:1px solid var(--border);
      background: rgba(15,23,42,.55);
      border-radius: 14px;
      padding: 10px 10px 8px;
      position:relative;
    }
    .msg.user{border-color: rgba(34,197,94,.25)}
    .msg.assistant{border-color: rgba(59,130,246,.25)}
    .meta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:6px;
      font-size:12px;
      color:var(--muted);
    }
    .meta .left{display:flex; gap:8px; align-items:center}
    .tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(17,24,39,.6);
      color: var(--muted);
    }
    .actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      margin-top:8px;
    }
    .iconBtn{
      border:1px solid var(--border);
      background: rgba(17,24,39,.5);
      color: var(--text);
      border-radius: 10px;
      padding: 7px 10px;
      cursor:pointer;
      font-size: 12px;
      font-weight:700;
    }
    .iconBtn:hover{border-color:#334155}
    .iconBtn.pinOn{border-color: rgba(245,158,11,.5); background: rgba(245,158,11,.12)}
    .composer{
      border-top:1px solid var(--border);
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      background: rgba(17,24,39,.55);
    }
    textarea{
      resize:none;
      min-height:44px;
      max-height:140px;
      width:100%;
    }
    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 13px;
      display:none;
      gap:10px;
      align-items:center;
      z-index: 9999;
    }
    .toast.show{display:flex}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background: var(--accent)}
    .dangerDot{background: var(--danger)}
    .warnDot{background: var(--warn)}

    .adminTable{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--border);
    }
    .adminTable th, .adminTable td{
      padding: 8px 10px;
      border-bottom:1px solid var(--border);
      color: var(--text);
      vertical-align: top;
    }
    .adminTable th{
      background: rgba(15,23,42,.6);
      text-align:left;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.2px;
    }
    .adminTable tr:last-child td{border-bottom:none}
    .small{font-size:12px}
    .hidden{display:none !important}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>Berke AI</b>
          <span>Google login + DB + pin/kopyala/ses + admin panel</span>
        </div>
      </div>

      <div class="pill" id="userPill">
        <span class="badge" id="statusBadge"><span class="dot"></span><span id="statusText">Kontrol ediliyor...</span></span>
        <span style="opacity:.45">•</span>
        <small id="userText">-</small>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: CHAT -->
      <div class="card chat">
        <div class="cardHeader">
          <div>
            <h2>Sohbet</h2>
            <div class="sub">Pin / Kopyala / Ses (TTS)</div>
          </div>
          <div class="row">
            <button class="btn danger" id="logoutBtn">Çıkış</button>
          </div>
        </div>

        <div class="chatList" id="chatList"></div>

        <div class="composer">
          <textarea class="input" id="msgInput" placeholder="Mesaj yaz..." rows="2"></textarea>
          <button class="btn primary" id="sendBtn">Gönder</button>
        </div>
      </div>

      <!-- RIGHT: AUTH + ADMIN -->
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Giriş</h2>
            <div class="sub">Google / Misafir</div>
          </div>
        </div>
        <div class="cardBody">
          <div id="authBox">
            <div class="row">
              <button class="btn primary" id="googleBtn">Google ile giriş</button>
              <button class="btn" id="guestBtn">Misafir olarak devam et</button>
            </div>
            <div class="divider"></div>
            <div class="muted small">
              Not: Giriş yaptıktan sonra mailin üstte görünecek ve oturum (session) kalıcı kalacak.
            </div>
          </div>

          <div id="loggedBox" class="hidden">
            <div class="muted small">Giriş yaptın:</div>
            <div style="margin-top:8px">
              <div><b id="meName">-</b></div>
              <div class="muted" id="meEmail">-</div>
            </div>
            <div class="divider"></div>
            <div class="row">
              <button class="btn" id="refreshBtn">Yenile</button>
              <button class="btn danger" id="logoutBtn2">Çıkış</button>
            </div>
          </div>

          <div class="divider"></div>

          <!-- IMAGE DISABLED -->
          <div>
            <h3 style="margin:0 0 6px;font-size:13px">Görsel (şimdilik kapalı)</h3>
            <div class="muted small">
              Şu an görsel üretimini kapattık. (Billing limit yüzünden). İstediğinde tekrar açarız.
            </div>
          </div>

          <div class="divider"></div>

          <!-- ADMIN -->
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <h3 style="margin:0;font-size:13px">Admin</h3>
              <span class="tag" id="adminState">Kapalı</span>
            </div>

            <div id="adminLoginBox" style="margin-top:10px">
              <input class="input" id="adminPw" type="password" placeholder="Admin şifresi" />
              <div class="row" style="margin-top:10px">
                <button class="btn warn" id="adminLoginBtn">Admin Giriş</button>
                <button class="btn" id="adminLoadBtn" disabled>Paneli Yükle</button>
              </div>
              <div class="muted small" style="margin-top:8px">
                Render ENV: <code>ADMIN_PASSWORD</code> set olmalı.
              </div>
            </div>

            <div id="adminPanel" class="hidden" style="margin-top:12px">
              <div class="row">
                <button class="btn" id="adminRefreshBtn">Yenile</button>
                <button class="btn danger" id="adminLogoutBtn">Admin Çıkış</button>
              </div>
              <div class="divider"></div>

              <div class="row" style="justify-content:space-between">
                <div>
                  <div class="muted small">Toplam Kullanıcı</div>
                  <div style="font-size:20px;font-weight:900" id="totalUsers">-</div>
                </div>
                <div>
                  <div class="muted small">Toplam Giriş</div>
                  <div style="font-size:20px;font-weight:900" id="totalLogins">-</div>
                </div>
              </div>

              <div class="divider"></div>

              <div class="muted small" style="margin-bottom:8px">Son 20 giriş</div>
              <div style="overflow:auto; max-height: 240px">
                <table class="adminTable">
                  <thead>
                    <tr>
                      <th>Zaman</th>
                      <th>Email</th>
                      <th>Provider</th>
                      <th>IP</th>
                    </tr>
                  </thead>
                  <tbody id="adminRows"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
  // ---------------------------
  // helpers
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  function toast(msg, type="ok"){
    const t = $("toast");
    const dot = type==="ok" ? "dot" : (type==="warn" ? "warnDot" : "dangerDot");
    t.innerHTML = `<span class="${dot}" style="display:inline-block;width:10px;height:10px;border-radius:999px;"></span><span>${escapeHtml(msg)}</span>`;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2600);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function api(url, method="GET", body=null){
    const opts = { method, headers: {} };
    if(body !== null){
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(url, opts);
    const data = await res.json().catch(()=> ({}));
    if(!res.ok){
      const msg = data?.detail || data?.error || ("HTTP " + res.status);
      throw new Error(msg);
    }
    return data;
  }

  function setStatus(loggedIn, user){
    const badge = $("statusBadge");
    const statusText = $("statusText");
    const userText = $("userText");

    if(loggedIn){
      badge.innerHTML = `<span class="dot"></span><span>Online</span>`;
      statusText.textContent = "Online";
      const label = user?.email || (user?.provider === "guest" ? "Guest" : "User");
      userText.textContent = label;
    } else {
      badge.innerHTML = `<span class="dangerDot" style="display:inline-block;width:8px;height:8px;border-radius:999px"></span><span>Offline</span>`;
      statusText.textContent = "Offline";
      userText.textContent = "Giriş yap";
    }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  async function loadMe(){
    const data = await api("/api/me");
    const user = data.user;
    const loggedIn = !!user;

    setStatus(loggedIn, user);

    $("authBox").classList.toggle("hidden", loggedIn);
    $("loggedBox").classList.toggle("hidden", !loggedIn);

    $("logoutBtn").disabled = !loggedIn;
    $("logoutBtn2").disabled = !loggedIn;

    if(loggedIn){
      $("meName").textContent = user?.name || (user?.provider === "guest" ? "Guest" : "User");
      $("meEmail").textContent = user?.email || (user?.provider === "guest" ? "Misafir" : "-");
      await loadHistory();
    } else {
      $("chatList").innerHTML = "";
    }
  }

  $("googleBtn").addEventListener("click", () => {
    window.location.href = "/auth/google";
  });

  $("guestBtn").addEventListener("click", async () => {
    try{
      await api("/auth/guest", "POST", {});
      toast("Misafir girişi tamam.", "ok");
      await loadMe();
    }catch(e){
      toast(e.message, "err");
    }
  });

  async function logout(){
    try{
      await api("/auth/logout", "POST", {});
      toast("Çıkış yapıldı.", "ok");
      await loadMe();
    }catch(e){
      toast(e.message, "err");
    }
  }
  $("logoutBtn").addEventListener("click", logout);
  $("logoutBtn2").addEventListener("click", logout);
  $("refreshBtn").addEventListener("click", loadMe);

  // ---------------------------
  // CHAT
  // ---------------------------
  function renderMsg(m){
    const roleLabel = m.role === "user" ? "Sen" : (m.role === "assistant" ? "Berke AI" : m.role);
    const pinned = !!m.pinned;

    const el = document.createElement("div");
    el.className = "msg " + (m.role === "user" ? "user" : "assistant");
    el.dataset.id = m.id;

    el.innerHTML = `
      <div class="meta">
        <div class="left">
          <span class="tag">${escapeHtml(roleLabel)}</span>
          ${pinned ? `<span class="tag" style="border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.1)">PIN</span>` : ``}
        </div>
        <div class="muted">${m.created_at ? escapeHtml(new Date(m.created_at).toLocaleString()) : ""}</div>
      </div>
      <div class="content">${escapeHtml(m.content).replaceAll("\n","<br>")}</div>
      <div class="actions">
        <button class="iconBtn ${pinned ? "pinOn":""}" data-act="pin">${pinned ? "Unpin":"Pin"}</button>
        <button class="iconBtn" data-act="copy">Kopyala</button>
        <button class="iconBtn" data-act="tts">Ses</button>
      </div>
    `;
    return el;
  }

  async function loadHistory(){
    try{
      const data = await api("/api/history");
      const list = $("chatList");
      list.innerHTML = "";
      for(const m of data.messages || []){
        list.appendChild(renderMsg(m));
      }
      list.scrollTop = list.scrollHeight;
    }catch(e){
      // not logged in
    }
  }

  $("sendBtn").addEventListener("click", sendMessage);
  $("msgInput").addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage(){
    const ta = $("msgInput");
    const text = (ta.value || "").trim();
    if(!text) return;

    $("sendBtn").disabled = true;
    ta.disabled = true;

    try{
      const data = await api("/api/chat", "POST", { message: text });
      ta.value = "";

      const list = $("chatList");
      list.appendChild(renderMsg(data.user_message));
      list.appendChild(renderMsg(data.assistant_message));
      list.scrollTop = list.scrollHeight;
    }catch(e){
      toast(e.message, "err");
    }finally{
      $("sendBtn").disabled = false;
      ta.disabled = false;
      ta.focus();
    }
  }

  // Actions: pin/copy/tts
  $("chatList").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    if(!act) return;
    const msgEl = e.target.closest(".msg");
    const msgId = parseInt(msgEl?.dataset?.id || "0", 10);
    if(!msgId) return;

    const contentEl = msgEl.querySelector(".content");
    const rawText = contentEl ? contentEl.innerText : "";

    if(act === "copy"){
      try{
        await navigator.clipboard.writeText(rawText);
        toast("Kopyalandı.", "ok");
      }catch(err){
        toast("Kopyalama engellendi. Tarayıcı izinlerini kontrol et.", "warn");
      }
      return;
    }

    if(act === "tts"){
      try{
        if(!("speechSynthesis" in window)){
          toast("Tarayıcı ses özelliği yok.", "warn");
          return;
        }
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(rawText);
        u.lang = "tr-TR";
        u.rate = 1.0;
        u.pitch = 1.0;
        window.speechSynthesis.speak(u);
        toast("Seslendiriliyor...", "ok");
      }catch(err){
        toast("Ses çalışmadı.", "warn");
      }
      return;
    }

    if(act === "pin"){
      const isPinned = btn.classList.contains("pinOn");
      const next = !isPinned;
      try{
        await api("/api/pin", "POST", { id: msgId, pinned: next });
        toast(next ? "Pinlendi." : "Pin kaldırıldı.", "ok");
        await loadHistory();
      }catch(err){
        toast(err.message, "err");
      }
      return;
    }
  });

  // ---------------------------
  // ADMIN
  // ---------------------------
  async function adminLogin(){
    const pw = ($("adminPw").value || "").trim();
    if(!pw){
      toast("Admin şifresi gir.", "warn");
      return;
    }
    try{
      await api("/admin/login", "POST", { password: pw });
      $("adminState").textContent = "Açık";
      $("adminState").style.borderColor = "rgba(34,197,94,.45)";
      $("adminState").style.background = "rgba(34,197,94,.12)";
      $("adminLoadBtn").disabled = false;
      toast("Admin giriş başarılı.", "ok");
      await loadAdmin();
    }catch(e){
      toast(e.message, "err");
    }
  }

  async function loadAdmin(){
    try{
      const s = await api("/admin/stats");
      $("adminPanel").classList.remove("hidden");
      $("adminLoadBtn").disabled = false;

      $("totalUsers").textContent = s.total_users ?? "-";
      $("totalLogins").textContent = s.total_logins ?? "-";

      const rows = $("adminRows");
      rows.innerHTML = "";
      for(const it of (s.last_20_logins || [])){
        const tr = document.createElement("tr");
        const dt = it.created_at ? new Date(it.created_at).toLocaleString() : "-";
        tr.innerHTML = `
          <td>${escapeHtml(dt)}</td>
          <td>${escapeHtml(it.email || "-")}</td>
          <td>${escapeHtml(it.provider || "-")}</td>
          <td>${escapeHtml(it.ip || "-")}</td>
        `;
        rows.appendChild(tr);
      }
      toast("Admin panel güncellendi.", "ok");
    }catch(e){
      $("adminPanel").classList.add("hidden");
      $("adminLoadBtn").disabled = true;
      $("adminState").textContent = "Kapalı";
      $("adminState").style.borderColor = "";
      $("adminState").style.background = "";
      toast("Admin değil / erişim yok: " + e.message, "warn");
    }
  }

  async function adminLogout(){
    try{
      await api("/admin/logout", "POST", {});
      $("adminPanel").classList.add("hidden");
      $("adminLoadBtn").disabled = true;
      $("adminState").textContent = "Kapalı";
      $("adminState").style.borderColor = "";
      $("adminState").style.background = "";
      toast("Admin çıkış yapıldı.", "ok");
    }catch(e){
      toast(e.message, "err");
    }
  }

  $("adminLoginBtn").addEventListener("click", adminLogin);
  $("adminLoadBtn").addEventListener("click", loadAdmin);
  $("adminRefreshBtn").addEventListener("click", loadAdmin);
  $("adminLogoutBtn").addEventListener("click", adminLogout);

  // ---------------------------
  // init
  // ---------------------------
  loadMe().catch(()=>{});
</script>
</body>
</html>
