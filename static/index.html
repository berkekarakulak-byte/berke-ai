<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Berke AI</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101826;
      --panel2:#0f1623;
      --text:#e8eefc;
      --muted:#a8b3cf;
      --line:rgba(255,255,255,.08);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --bubbleUser: rgba(110,231,255,.12);
      --bubbleAI: rgba(167,139,250,.10);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#f0f3ff;
      --text:#0a0d14;
      --muted:#475569;
      --line:rgba(2,6,23,.10);
      --bubbleUser: rgba(2,132,199,.10);
      --bubbleAI: rgba(124,58,237,.10);
      --shadow: 0 12px 40px rgba(2,6,23,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 10% 10%, rgba(110,231,255,.18), transparent 55%),
                  radial-gradient(1000px 650px at 90% 0%, rgba(167,139,250,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:min(1100px, 100%);
      height:min(760px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%), var(--panel);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .topbar{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.35), transparent),
                  linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(110,231,255,.18);
    }
    .brand h1{
      font-size:16px; margin:0; letter-spacing:.4px;
      line-height:1.1;
    }
    .brand .sub{
      font-size:12px; color:var(--muted);
    }
    .actions{
      display:flex; align-items:center; gap:10px;
    }
    .chip{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      display:flex; align-items:center; gap:8px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition: transform .05s ease, background .2s ease;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#0b0f17;
    }
    .btn.danger{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
    }
    .btn.icon{
      width:44px; padding:10px 0;
    }
    .main{
      flex:1;
      display:flex;
      min-height:0;
    }
    .left{
      width: 320px;
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      padding:14px;
      display:flex; flex-direction:column;
      gap:12px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.03);
    }
    .card h3{ margin:0 0 6px; font-size:13px; }
    .card p{ margin:0; font-size:12px; color:var(--muted); line-height:1.4; }
    .right{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
      min-height:0;
    }
    /* Chat */
    .chat{
      flex:1;
      min-height:0;
      padding:16px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .row.user{ justify-content:flex-end; }
    .bubble{
      max-width:min(720px, 92%);
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      position:relative;
    }
    .row.user .bubble{
      background: var(--bubbleUser);
      border-color: rgba(110,231,255,.22);
    }
    .row.ai .bubble{
      background: var(--bubbleAI);
      border-color: rgba(167,139,250,.22);
    }
    .meta{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:11px;
      color:var(--muted);
    }
    .meta .tools{
      display:flex; gap:8px; align-items:center;
    }
    .tool{
      cursor:pointer;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      user-select:none;
    }
    .tool:hover{ background: rgba(255,255,255,.05); }
    .pinned{
      border-color: rgba(34,197,94,.35) !important;
      box-shadow: 0 0 0 2px rgba(34,197,94,.08) inset;
    }
    /* Composer */
    .composer{
      border-top:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.03));
      padding:12px;
    }
    .composerInner{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      min-height:46px;
      max-height:140px;
      resize:none;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:14px;
      line-height:1.35;
    }
    textarea::placeholder{ color: rgba(168,179,207,.75); }
    .small{
      font-size:12px; color:var(--muted);
      padding:8px 12px;
    }

    /* Onboarding modal */
    .modal{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal.show{ display:flex; }
    .modalBox{
      width:min(520px, 100%);
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modalHead h2{ margin:0; font-size:15px; }
    .modalBody{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .modalBody input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .hint{ font-size:12px; color:var(--muted); line-height:1.4; }

    /* Responsive */
    @media (max-width: 900px){
      .left{ display:none; }
      .brand{ min-width:auto; }
    }
  </style>
</head>

<body data-theme="dark">
<div class="wrap">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Berke AI</h1>
          <div class="sub" id="subline">premium sohbet ‚Ä¢ hƒ±zlƒ± ‚Ä¢ karanlƒ±k mod</div>
        </div>
      </div>

      <div class="actions">
        <div class="chip" id="whoChip">üîí Giri≈ü gerekli</div>
        <button class="btn icon" id="themeBtn" title="Tema">
          üåô
        </button>
        <button class="btn icon" id="soundBtn" title="Ses">
          üîä
        </button>
        <button class="btn" id="adminBtn" style="display:none;">üõ°Ô∏è Admin</button>
        <button class="btn danger" id="logoutBtn" style="display:none;">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <div class="card">
          <h3>Hƒ±zlƒ± komutlar</h3>
          <p>‚Ä¢ ‚ÄúBeni motive et‚Äù</p>
          <p>‚Ä¢ ‚ÄúPlan √ßƒ±kar‚Äù</p>
          <p>‚Ä¢ ‚ÄúKod yaz‚Äù</p>
        </div>
        <div class="card">
          <h3>Not</h3>
          <p>G√∂rsel √ºretim butonu a√ßƒ±k. Billing limit varsa hata g√∂sterebilir.</p>
        </div>
        <div class="card">
          <h3>P√ºf</h3>
          <p>Enter: g√∂nder ‚Ä¢ Shift+Enter: alt satƒ±r</p>
        </div>
      </div>

      <div class="right">
        <div class="chat" id="chat"></div>

        <div class="composeriver" style="display:none;" id="typingHint"></div>

        <div class="composer">
          <div class="composerInner">
            <textarea id="msg" placeholder="Mesajƒ±nƒ± yaz... (Enter g√∂nderir)"></textarea>
            <button class="btn" id="imgBtn" title="G√∂rsel √ºret">
              üñºÔ∏è
            </button>
            <button class="btn primary" id="sendBtn">
              G√∂nder ‚Üµ
            </button>
          </div>
          <div class="small" id="statusLine"></div>
        </div>
      </div>
    </div>

    <!-- Onboarding -->
    <div class="modal" id="modal">
      <div class="modalBox">
        <div class="modalHead">
          <h2>Giri≈ü yap</h2>
          <button class="btn icon" id="closeModal">‚úï</button>
        </div>
        <div class="modalBody">
          <div class="hint">
            Google ile giri≈ü yapabilir ya da misafir devam edebilirsin.
          </div>

          <div class="stack">
            <button class="btn primary" id="googleBtn">
              <span style="font-size:16px">G</span> Google ile giri≈ü yap
            </button>

            <div class="card" style="margin:0">
              <h3 style="margin-bottom:8px">Misafir</h3>
              <input id="guestName" placeholder="Takma ad (opsiyonel)" />
              <button class="btn" id="guestBtn">Misafir olarak devam et</button>
              <div class="hint" style="margin-top:8px">
                Misafir giri≈üte e-posta kaydƒ± olmaz.
              </div>
            </div>
          </div>

          <div class="hint" id="modalErr" style="color: var(--bad); display:none"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  const chatEl = document.getElementById("chat");
  const msgEl = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");
  const imgBtn = document.getElementById("imgBtn");
  const statusLine = document.getElementById("statusLine");
  const whoChip = document.getElementById("whoChip");
  const adminBtn = document.getElementById("adminBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const modal = document.getElementById("modal");
  const closeModal = document.getElementById("closeModal");
  const googleBtn = document.getElementById("googleBtn");
  const guestBtn = document.getElementById("guestBtn");
  const guestName = document.getElementById("guestName");
  const modalErr = document.getElementById("modalErr");

  const themeBtn = document.getElementById("themeBtn");
  const soundBtn = document.getElementById("soundBtn");

  let soundOn = true;
  let pinnedIds = new Set();
  const PIN_KEY = "berke_ai_pins_v1";
  const THEME_KEY = "berke_ai_theme_v1";
  const SOUND_KEY = "berke_ai_sound_v1";

  function loadPrefs(){
    try{
      const pins = JSON.parse(localStorage.getItem(PIN_KEY) || "[]");
      pinnedIds = new Set(pins);
    }catch{}
    const t = localStorage.getItem(THEME_KEY);
    if(t) document.body.setAttribute("data-theme", t);
    const s = localStorage.getItem(SOUND_KEY);
    if(s) soundOn = (s === "1");
    themeBtn.textContent = document.body.getAttribute("data-theme")==="dark" ? "üåô" : "‚òÄÔ∏è";
    soundBtn.textContent = soundOn ? "üîä" : "üîá";
  }

  function savePins(){
    localStorage.setItem(PIN_KEY, JSON.stringify([...pinnedIds]));
  }

  function beep(type="send"){
    if(!soundOn) return;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = type==="send" ? 520 : 330;
    g.gain.value = 0.04;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 90);
  }

  function fmtTime(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }catch{
      return "";
    }
  }

  function escapeHtml(str){
    return (str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function addBubble(role, text, ts=new Date().toISOString()){
    const id = crypto.randomUUID();
    const row = document.createElement("div");
    row.className = "row " + (role==="user" ? "user" : "ai");

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.dataset.id = id;

    const content = document.createElement("div");
    content.innerHTML = escapeHtml(text).replaceAll("\n","<br/>");
    bubble.appendChild(content);

    const meta = document.createElement("div");
    meta.className = "meta";

    const left = document.createElement("div");
    left.textContent = fmtTime(ts);

    const tools = document.createElement("div");
    tools.className = "tools";

    const copy = document.createElement("div");
    copy.className = "tool";
    copy.textContent = "Kopyala";
    copy.onclick = async ()=>{
      await navigator.clipboard.writeText(text);
      status("Kopyalandƒ± ‚úÖ");
      beep("send");
    };

    const pin = document.createElement("div");
    pin.className = "tool";
    pin.textContent = pinnedIds.has(id) ? "Pinned" : "Pin";
    pin.onclick = ()=>{
      if(pinnedIds.has(id)){
        pinnedIds.delete(id);
        bubble.classList.remove("pinned");
        pin.textContent = "Pin";
        status("Pin kaldƒ±rƒ±ldƒ±");
      }else{
        pinnedIds.add(id);
        bubble.classList.add("pinned");
        pin.textContent = "Pinned";
        status("Pinlendi üìå");
      }
      savePins();
      beep("send");
    };

    tools.appendChild(copy);
    tools.appendChild(pin);

    meta.appendChild(left);
    meta.appendChild(tools);

    bubble.appendChild(meta);
    row.appendChild(bubble);
    chatEl.appendChild(row);

    if(pinnedIds.has(id)){
      bubble.classList.add("pinned");
      pin.textContent = "Pinned";
    }

    chatEl.scrollTop = chatEl.scrollHeight;
    return id;
  }

  function status(txt, kind=""){
    statusLine.textContent = txt || "";
  }

  async function apiMe(){
    const r = await fetch("/api/me", {credentials:"include"});
    return await r.json();
  }

  function showModal(show=true){
    modal.classList.toggle("show", show);
    modalErr.style.display = "none";
    modalErr.textContent = "";
  }

  async function refreshAuthUI(){
    const me = await apiMe();
    if(!me.logged_in){
      whoChip.textContent = "üîí Giri≈ü gerekli";
      adminBtn.style.display = "none";
      logoutBtn.style.display = "none";
      showModal(true);
      return;
    }

    showModal(false);

    if(me.mode==="google"){
      whoChip.textContent = "‚úÖ " + (me.email || "Google kullanƒ±cƒ±");
    }else{
      whoChip.textContent = "üë§ " + (me.name || "Misafir");
    }

    logoutBtn.style.display = "inline-flex";
    adminBtn.style.display = me.is_admin ? "inline-flex" : "none";

    if(chatEl.children.length===0){
      addBubble("ai", "Selam! Buradayƒ±m üòÑ Ne yapalƒ±m bug√ºn?");
    }
  }

  // Enter g√∂nder / Shift+Enter alt satƒ±r
  msgEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendBtn.click();
    }
  });

  sendBtn.onclick = async ()=>{
    const text = msgEl.value.trim();
    if(!text) return;

    beep("send");
    addBubble("user", text);
    msgEl.value = "";
    status("Yazƒ±yor...");

    const r = await fetch("/api/chat", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      credentials:"include",
      body: JSON.stringify({message:text})
    });

    const data = await r.json();
    if(!r.ok){
      status(data.detail || "Hata");
      addBubble("ai", "≈ûu an teknik bir sorun var ama buradayƒ±m.");
      return;
    }

    addBubble("ai", data.reply || "(bo≈ü cevap)", data.ts || new Date().toISOString());
    status("");
    beep("recv");
  };

  imgBtn.onclick = async ()=>{
    const prompt = promptText();
    if(!prompt) return;

    beep("send");
    status("G√∂rsel √ºretiliyor...");

    const r = await fetch("/api/image", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      credentials:"include",
      body: JSON.stringify({prompt})
    });

    const data = await r.json();
    if(!r.ok){
      status(data.detail || "G√∂rsel hatasƒ±");
      addBubble("ai", "G√∂rsel √ºretim ba≈üarƒ±sƒ±z: " + (data.detail || "Bilinmeyen hata"));
      return;
    }

    // url varsa g√∂ster
    if(data.url){
      addBubble("ai", "G√∂rsel hazƒ±r üëá");
      const row = document.createElement("div");
      row.className = "row ai";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">
        <img src="${data.url}" style="width:100%;max-width:520px;border-radius:14px;border:1px solid var(--line)" />
        <div class="meta"><div>${fmtTime(data.ts || new Date().toISOString())}</div><div class="tools"></div></div>
      </div>`;
      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      status("");
      beep("recv");
      return;
    }

    // b64 varsa g√∂ster
    if(data.b64){
      addBubble("ai", "G√∂rsel hazƒ±r üëá");
      const src = "data:image/png;base64," + data.b64;
      const row = document.createElement("div");
      row.className = "row ai";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">
        <img src="${src}" style="width:100%;max-width:520px;border-radius:14px;border:1px solid var(--line)" />
        <div class="meta"><div>${fmtTime(data.ts || new Date().toISOString())}</div><div class="tools"></div></div>
      </div>`;
      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      status("");
      beep("recv");
      return;
    }

    status("G√∂rsel d√∂nd√ºr√ºlmedi.");
  };

  function promptText(){
    const p = window.prompt("G√∂rsel i√ßin kƒ±sa a√ßƒ±klama yaz:");
    return (p||"").trim();
  }

  // Theme toggle
  themeBtn.onclick = ()=>{
    const cur = document.body.getAttribute("data-theme");
    const next = (cur==="dark") ? "light" : "dark";
    document.body.setAttribute("data-theme", next);
    localStorage.setItem(THEME_KEY, next);
    themeBtn.textContent = next==="dark" ? "üåô" : "‚òÄÔ∏è";
    beep("send");
  };

  // Sound toggle
  soundBtn.onclick = ()=>{
    soundOn = !soundOn;
    localStorage.setItem(SOUND_KEY, soundOn ? "1" : "0");
    soundBtn.textContent = soundOn ? "üîä" : "üîá";
    beep("send");
    status(soundOn ? "Ses a√ßƒ±ldƒ±" : "Ses kapandƒ±");
    setTimeout(()=>status(""), 800);
  };

  // Admin
  adminBtn.onclick = ()=>{
    window.location.href = "/admin-ui";
  };

  // Logout
  logoutBtn.onclick = async ()=>{
    await fetch("/logout", {method:"POST", credentials:"include"});
    chatEl.innerHTML = "";
    status("");
    await refreshAuthUI();
  };

  // Modal buttons
  closeModal.onclick = ()=>{ /* kapatma yok; login zorunlu hissi */ };

  googleBtn.onclick = ()=>{
    // OAuth redirect
    window.location.href = "/auth/google";
  };

  guestBtn.onclick = async ()=>{
    const name = (guestName.value || "").trim();
    const r = await fetch("/auth/guest", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      credentials:"include",
      body: JSON.stringify({name})
    });
    const data = await r.json();
    if(!r.ok){
      modalErr.style.display="block";
      modalErr.textContent = data.detail || "Misafir giri≈ü hata";
      return;
    }
    await refreshAuthUI();
  };

  // Init
  loadPrefs();
  refreshAuthUI();
</script>
</body>
</html>
