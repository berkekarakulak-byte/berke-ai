<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berke AI</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f17; color:#e7eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button, input { border-radius: 10px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.08); color:#e7eefc; padding: 10px 12px; }
    button { cursor:pointer; }
    button.primary { background: rgba(99,102,241,0.32); border-color: rgba(99,102,241,0.55); }
    button.danger { background: rgba(239,68,68,0.22); border-color: rgba(239,68,68,0.45); }
    button.ok { background: rgba(16,185,129,0.22); border-color: rgba(16,185,129,0.45); }
    .muted { opacity: .78; }
    .hide { display:none !important; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.10); }
    .chatbox { height: 430px; overflow:auto; padding: 10px; border-radius: 12px; border:1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.25); }
    .msg { padding: 10px; border-radius: 12px; margin: 8px 0; border:1px solid rgba(255,255,255,0.10); }
    .msg.user { background: rgba(99,102,241,0.14); }
    .msg.assistant { background: rgba(255,255,255,0.06); }
    .msg .meta { font-size: 12px; opacity:.75; margin-bottom: 6px; display:flex; justify-content:space-between; gap:8px; }
    .msg .tools { display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .msg .tools button { padding: 6px 9px; font-size: 12px; border-radius: 999px; }
    textarea { width:100%; min-height: 90px; resize: vertical; border-radius: 12px; padding: 12px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color:#e7eefc; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){
      .grid { grid-template-columns: 1fr 320px; }
    }
    .modalback { position:fixed; inset:0; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; padding: 18px; }
    .modal { width: min(520px, 100%); }
    .err { color:#ffb4b4; white-space: pre-wrap; }
    .oktxt { color:#b9ffd7; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div class="row">
        <h2 style="margin:0;">Berke AI</h2>
        <span class="pill" id="userPill" class="muted">Y√ºkleniyor‚Ä¶</span>
      </div>
      <div class="row">
        <button id="btnAdminOpen">Admin</button>
        <button id="btnLogout" class="danger hide">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div id="loginPanel" class="row">
          <button id="btnGoogle" class="primary">Google ile giri≈ü</button>
          <button id="btnGuest">Misafir devam et</button>
          <span class="muted">Giri≈ü sonrasƒ±: sohbet + email g√∂r√ºn√ºr, login kalƒ±cƒ± olur.</span>
        </div>

        <div id="chatPanel" class="hide">
          <div class="row" style="margin-bottom:10px;">
            <button id="btnClear">Sohbeti temizle</button>
            <button id="btnPinned">üìå Pinliler</button>
            <span class="muted" id="status"></span>
          </div>

          <div class="chatbox" id="chatbox"></div>

          <div style="margin-top:10px;">
            <textarea id="input" placeholder="Mesaj yaz‚Ä¶"></textarea>
            <div class="row" style="margin-top:10px;">
              <button id="btnSend" class="ok">G√∂nder</button>
              <button id="btnSpeakLast">üîä Son cevabƒ± oku</button>
            </div>
            <div id="err" class="err" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Admin Panel</h3>
        <div class="muted" style="margin-bottom:10px;">Admin giri≈ü sonrasƒ± kullanƒ±cƒ±/listeler g√∂r√ºn√ºr.</div>

        <div id="adminLocked">
          <input id="adminPw" type="password" placeholder="Admin ≈üifre" style="width:100%;box-sizing:border-box;">
          <button id="btnAdminLogin" class="primary" style="width:100%; margin-top:10px;">Admin Giri≈ü</button>
          <div id="adminErr" class="err" style="margin-top:10px;"></div>
        </div>

        <div id="adminPanel" class="hide">
          <div class="row" style="justify-content:space-between;">
            <button id="btnAdminRefresh">Yenile</button>
            <button id="btnAdminLogout" class="danger">Admin √áƒ±kƒ±≈ü</button>
          </div>
          <div id="adminOut" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pinned Modal -->
  <div id="pinModal" class="modalback hide">
    <div class="card modal">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0;">üìå Pinliler</h3>
        <button id="btnPinClose">Kapat</button>
      </div>
      <div id="pinList" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const chatbox = $("chatbox");
  const errBox = $("err");
  const statusEl = $("status");

  let meState = null;
  let history = []; // {role, content}
  let pinned = []; // {content, ts}

  function setErr(msg){
    errBox.textContent = msg || "";
  }

  function setStatus(msg){
    statusEl.textContent = msg || "";
  }

  function scrollBottom(){
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function addMsg(role, content){
    const div = document.createElement("div");
    div.className = "msg " + (role === "user" ? "user" : "assistant");
    const ts = new Date().toLocaleString();

    div.innerHTML = `
      <div class="meta">
        <span>${role === "user" ? "Sen" : "Berke AI"}</span>
        <span class="muted">${escapeHtml(ts)}</span>
      </div>
      <div class="content">${escapeHtml(content).replaceAll("\\n","<br>")}</div>
      <div class="tools">
        <button class="btnCopy">Kopyala</button>
        <button class="btnPin">Pin</button>
        <button class="btnSpeak">Ses</button>
      </div>
    `;

    div.querySelector(".btnCopy").onclick = async () => {
      try{
        await navigator.clipboard.writeText(content);
        setStatus("Kopyalandƒ± ‚úÖ");
        setTimeout(()=>setStatus(""), 1200);
      }catch(e){
        setErr("Kopyalama izni yok: " + e);
      }
    };

    div.querySelector(".btnPin").onclick = () => {
      pinned.unshift({content, ts: Date.now()});
      localStorage.setItem("pinned", JSON.stringify(pinned));
      setStatus("Pinlendi üìå");
      setTimeout(()=>setStatus(""), 1200);
    };

    div.querySelector(".btnSpeak").onclick = () => speak(content);

    chatbox.appendChild(div);
    scrollBottom();
  }

  function speak(text){
    try{
      if(!("speechSynthesis" in window)){
        setErr("Bu tarayƒ±cƒ± TTS desteklemiyor.");
        return;
      }
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "tr-TR";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){
      setErr("Ses hatasƒ±: " + e);
    }
  }

  async function api(path, opts={}){
    const res = await fetch(path, {
      credentials: "include",
      headers: {"Content-Type":"application/json"},
      ...opts
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok){
      const detail = data?.detail || JSON.stringify(data) || ("HTTP " + res.status);
      throw new Error(detail);
    }
    return data;
  }

  function renderMe(){
    const pill = $("userPill");
    const u = meState?.user;
    if(u){
      pill.textContent = `${u.email} (${u.provider})`;
      $("btnLogout").classList.remove("hide");
      $("loginPanel").classList.add("hide");
      $("chatPanel").classList.remove("hide");
    } else {
      pill.textContent = "Giri≈ü yapƒ±lmadƒ±";
      $("btnLogout").classList.add("hide");
      $("loginPanel").classList.remove("hide");
      $("chatPanel").classList.add("hide");
    }

    // admin UI
    const admin = meState?.is_admin;
    if(admin){
      $("adminLocked").classList.add("hide");
      $("adminPanel").classList.remove("hide");
    }else{
      $("adminLocked").classList.remove("hide");
      $("adminPanel").classList.add("hide");
    }
  }

  async function refreshMe(){
    meState = await api("/me", {method:"GET", headers:{}});
    renderMe();
  }

  async function doAdminStats(){
    const out = $("adminOut");
    out.innerHTML = `<div class="muted">Y√ºkleniyor‚Ä¶</div>`;
    try{
      const stats = await api("/admin/stats", {method:"GET", headers:{}});
      const users = stats.users || [];
      const logins = stats.logins_last_50 || [];

      out.innerHTML = `
        <div class="pill">DB: ${stats.db ? "‚úÖ" : "‚ùå"}</div>
        <h4>Kullanƒ±cƒ±lar (son 200)</h4>
        <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,0.10); border-radius:12px; padding:10px;">
          ${users.map(u => `
            <div style="margin-bottom:10px;">
              <div><b>${escapeHtml(u.email)}</b></div>
              <div class="muted">${escapeHtml(u.name||"")} ‚Ä¢ last_login: ${escapeHtml(u.last_login||"")}</div>
            </div>
          `).join("") || `<div class="muted">Kayƒ±t yok</div>`}
        </div>

        <h4 style="margin-top:14px;">Login Events (son 50)</h4>
        <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,0.10); border-radius:12px; padding:10px;">
          ${logins.map(l => `
            <div style="margin-bottom:8px;">
              <div><b>${escapeHtml(l.email||"")}</b> <span class="muted">(${escapeHtml(l.provider||"")})</span></div>
              <div class="muted">${escapeHtml(l.created_at||"")}</div>
            </div>
          `).join("") || `<div class="muted">Kayƒ±t yok</div>`}
        </div>
      `;
    }catch(e){
      out.innerHTML = `<div class="err">${escapeHtml(e.message)}</div>`;
    }
  }

  // Buttons
  $("btnGoogle").onclick = () => { window.location.href = "/login/google"; };

  $("btnGuest").onclick = async () => {
    setErr("");
    try{
      await api("/login/guest", {method:"POST", body: JSON.stringify({})});
      await refreshMe();
    }catch(e){
      setErr(e.message);
    }
  };

  $("btnLogout").onclick = async () => {
    setErr("");
    try{
      await api("/logout", {method:"POST", body: "{}"});
      history = [];
      chatbox.innerHTML = "";
      await refreshMe();
    }catch(e){
      setErr(e.message);
    }
  };

  $("btnSend").onclick = async () => {
    setErr("");
    const msg = $("input").value.trim();
    if(!msg) return;

    $("input").value = "";
    addMsg("user", msg);
    history.push({role:"user", content: msg});

    setStatus("Yazƒ±yor‚Ä¶");
    try{
      const r = await api("/api/chat", {
        method:"POST",
        body: JSON.stringify({message: msg, history})
      });
      const ans = r.answer || "";
      addMsg("assistant", ans);
      history.push({role:"assistant", content: ans});
      setStatus("");
    }catch(e){
      setStatus("");
      setErr(e.message);
    }
  };

  $("btnSpeakLast").onclick = () => {
    const last = [...history].reverse().find(x => x.role === "assistant");
    if(last) speak(last.content);
  };

  $("btnClear").onclick = () => {
    history = [];
    chatbox.innerHTML = "";
    setStatus("Temizlendi.");
    setTimeout(()=>setStatus(""), 900);
  };

  // Pin modal
  $("btnPinned").onclick = () => {
    $("pinModal").classList.remove("hide");
    renderPins();
  };
  $("btnPinClose").onclick = () => $("pinModal").classList.add("hide");

  function renderPins(){
    const el = $("pinList");
    if(!pinned.length){
      el.innerHTML = `<div class="muted">Hen√ºz pin yok.</div>`;
      return;
    }
    el.innerHTML = pinned.map((p, idx) => `
      <div class="msg assistant">
        <div class="meta">
          <span>Pin #${idx+1}</span>
          <span class="muted">${new Date(p.ts).toLocaleString()}</span>
        </div>
        <div>${escapeHtml(p.content).replaceAll("\\n","<br>")}</div>
        <div class="tools">
          <button onclick="navigator.clipboard.writeText(${JSON.stringify(p.content)})">Kopyala</button>
          <button onclick="speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance(${JSON.stringify(p.content)}))">Ses</button>
          <button class="danger" onclick="removePin(${idx})">Sil</button>
        </div>
      </div>
    `).join("");
  }

  window.removePin = (idx) => {
    pinned.splice(idx, 1);
    localStorage.setItem("pinned", JSON.stringify(pinned));
    renderPins();
  };

  // Admin
  $("btnAdminLogin").onclick = async () => {
    $("adminErr").textContent = "";
    try{
      const pw = $("adminPw").value;
      await api("/admin/login", {method:"POST", body: JSON.stringify({password: pw})});
      await refreshMe();
      await doAdminStats();
    }catch(e){
      $("adminErr").textContent = e.message;
    }
  };

  $("btnAdminRefresh").onclick = doAdminStats;

  $("btnAdminLogout").onclick = async () => {
    $("adminErr").textContent = "";
    try{
      await api("/admin/logout", {method:"POST", body: "{}"});
      await refreshMe();
    }catch(e){
      $("adminErr").textContent = e.message;
    }
  };

  $("btnAdminOpen").onclick = async () => {
    // sadece saƒü panel zaten a√ßƒ±k; admin stats varsa yenile
    try{
      await refreshMe();
      if(meState?.is_admin) await doAdminStats();
    }catch(e){}
  };

  // Init
  (async () => {
    pinned = JSON.parse(localStorage.getItem("pinned") || "[]");
    try{
      await refreshMe();
      if(meState?.is_admin) await doAdminStats();
    }catch(e){
      $("userPill").textContent = "Sunucuya eri≈üilemiyor";
      setErr(e.message);
    }
  })();
</script>
</body>
</html>
